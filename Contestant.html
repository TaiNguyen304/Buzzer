<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thí sinh - Bấm chuông</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ... (GIỮ NGUYÊN CSS CŨ) ... */
        body {
            background-color: #F3F4F6;
            color: #111827;
            font-family: Arial, Helvetica, sans-serif;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            max-width: 32rem;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
        }

        #loginSection {
            background-color: #FFFFFF;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        #loginSection h1 {
            font-size: 1.875rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            text-align: center;
            color: blue;
        }

        .space-y-4>div {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: bold;
            color: purple;
            margin-bottom: 0.25rem;
            text-align: center;
            align-items: center;
        }

        input[type="number"],
        input[type="text"] {
            width: 94%;
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-size: 1.125rem;
            text-align: center;
            align-items: center;
            font-weight: bold;
        }

        input[type="number"] {
            font-family: Arial, Helvetica, sans-serif, monospace;
        }

        #roomCodeInput {
            background-color: white;
            color: black !important;
            font-weight: bold;
            border-color: purple;
            box-shadow: 0 0 0 3px purple;
        }

        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: purple;
            box-shadow: 0 0 0 3px purple;
        }

        #joinRoomBtn {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition-property: all;
            transition-duration: 200ms;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            background-color: yellow;
            color: #000000;
            width: 100%;
            font-size: 1.125rem;
            border: none;
            cursor: pointer;
        }

        #joinRoomBtn:hover {
            background-color: orange;
            color: #FFFFFF;
        }

        #errorMessage {
            color: red;
            text-align: center;
            font-weight: bold;
            margin-top: 1rem;
        }

        #buzzerSection {
            text-align: center;
        }

        #buzzerSection h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        #roomCodeDisplay {
            font-family: Arial, Helvetica, sans-serif, monospace;
            color: blue;
        }

        #buzzerSection h3 {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
        }

        #usernameDisplay {
            color: purple;
        }

        .buzzer-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.25rem;
        }

        #buzzerBtn {
            width: 600px;
            height: 200px;
            font-size: 2.5rem;
            font-weight: bold;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition-property: all;
            transition-duration: 200ms;
            transform-origin: center;
            border: none;
        }

        #buzzerBtn.active {
            background-color: green;
            color: #FFFFFF;
            cursor: pointer;
        }

        #buzzerBtn.active:hover {
            background-color: orange;
            transform: scale(1.05);
        }

        #buzzerBtn.buzzed {
            background-color: blue;
            color: #FFFFFF;
            cursor: not-allowed;
        }

        #buzzerBtn.locked {
            background-color: red;
            color: #FFFFFF;
            cursor: not-allowed;
        }

        #buzzerStatus {
            width: 600px;
            height: 5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }

        #buzzerStatus.status-waiting {
            background-color: #ff00cc;
            color: #FFFFFF;
        }

        #buzzerStatus.status-active {
            background-color: green;
            color: white;
        }

        #buzzerStatus.status-buzzed {
            background-color: red;
            color: #FFFFFF;
        }

        .latest-buzz {
            background-color: blue !important;
            color: white !important;
        }

        .latest-buzz td {
            background-color: blue !important;
            color: white !important;
            font-weight: bold;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-900 font-sans p-6 flex items-center justify-center min-h-screen">

    <audio id="buzzSound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>

    <div class="container">

        <div id="loginSection">
            <h1>Tham gia phòng</h1>
            <div class="space-y-4">
                <div>
                    <label for="roomCodeInput">Mã phòng (6 chữ số):</label>
                    <input type="number" id="roomCodeInput" maxlength="6">
                </div>
                <div>
                    <label for="usernameInput">Username (Tên của bạn):</label>
                    <input type="text" id="usernameInput">
                </div>
                <button id="joinRoomBtn">Xác nhận</button>
            </div>
            <p id="errorMessage"></p>
        </div>

        <div id="buzzerSection" style="display: none;">
            <h2>Phòng <span id="roomCodeDisplay"></span></h2>
            <h3>Chào, <span id="usernameDisplay"></span></h3>

            <div class="buzzer-controls">
                <button id="buzzerBtn" disabled>Đang kết nối...</button>
                <div id="buzzerStatus" class="status-waiting">Vui lòng chờ Host...</div>
            </div>
        </div>

    </div>

    <script>
        // --- CẤU HÌNH SUPABASE (THAY THẾ BẰNG THÔNG TIN CỦA BẠN) ---
        const SUPABASE_URL = 'https://gyyjabuewruokczpqekz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5eWphYnVld3J1b2tjenBxZWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzOTk5NTksImV4cCI6MjA3OTk3NTU5OX0.bCsceRhW02FySQOdk61XnMLahTWtxCZIcpvvSIUNuIU';
        // ĐÃ SỬA LỖI: Đổi tên biến thành supabaseClient để tránh xung đột với đối tượng toàn cục 'supabase'
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // -------------------------------------------------------------

        let userId = null;
        let currentRoomId = null;
        let username = null;
        let currentRoomData = null;
        let iHaveBuzzed = false;
        let myBuzzTime = null;
        let previousBuzzCount = 0;
        let supabaseChannel = null;

        const loginSection = document.getElementById('loginSection');
        const buzzerSection = document.getElementById('buzzerSection');
        const buzzerBtn = document.getElementById('buzzerBtn');
        const buzzerStatus = document.getElementById('buzzerStatus');
        const errorMessage = document.getElementById('errorMessage');
        const buzzSound = document.getElementById('buzzSound');

        // Hàm phát nhạc
        function playBuzzerSound() {
            if (buzzSound) {
                buzzSound.currentTime = 0;
                buzzSound.play().catch(e => console.log("Audio play failed (interaction required)", e));
            }
        }

        // Khởi tạo trạng thái ban đầu
        document.getElementById('joinRoomBtn').textContent = 'Xác nhận';
        document.getElementById('joinRoomBtn').disabled = false;
        userId = `user-${Math.random().toString(36).substring(2, 9)}`; // Tạo ID ngẫu nhiên

        function setErrorMessage(message) {
            errorMessage.textContent = message;
            document.getElementById('joinRoomBtn').disabled = false;
        }

        async function joinRoom() {
            if (!userId) { setErrorMessage("Lỗi kết nối."); return; }
            const roomId = document.getElementById('roomCodeInput').value.trim();
            const inputUsername = document.getElementById('usernameInput').value.trim();
            if (!roomId || roomId.length !== 6) { setErrorMessage("Mã phòng phải là 6 chữ số."); return; }
            if (!inputUsername) { setErrorMessage("Vui lòng nhập Username."); return; }

            errorMessage.textContent = "Đang tham gia phòng...";
            document.getElementById('joinRoomBtn').disabled = true;

            const newParticipant = { userId, username: inputUsername, socketId: userId };
            
            try {
                // 1. Lấy trạng thái phòng hiện tại
                let { data: room, error } = await supabaseClient // SỬA
                    .from('rooms')
                    .select('room_data')
                    .eq('id', roomId)
                    .single();

                if (error || !room) {
                    setErrorMessage("Phòng không tồn tại hoặc lỗi server.");
                    return;
                }

                currentRoomData = room.room_data;
                const participants = currentRoomData.participants || [];

                // 2. Cập nhật danh sách người tham gia (nếu chưa có)
                if (!participants.some(p => p.userId === userId || p.username === inputUsername)) {
                    participants.push(newParticipant);
                    const { error: updateError } = await supabaseClient // SỬA
                        .from('rooms')
                        .update({ room_data: { ...currentRoomData, participants: participants } })
                        .eq('id', roomId);

                    if (updateError) {
                        console.error("Lỗi khi cập nhật người tham gia:", updateError);
                        setErrorMessage("Lỗi khi cập nhật danh sách người tham gia.");
                        return;
                    }
                }

                // 3. Thiết lập Realtime Subscription
                setupRealtimeListener(roomId);

                // 4. Cập nhật UI
                currentRoomId = roomId;
                username = inputUsername;
                loginSection.style.display = 'none';
                buzzerSection.style.display = 'block';
                document.getElementById('roomCodeDisplay').textContent = currentRoomId;
                document.getElementById('usernameDisplay').textContent = username;
                errorMessage.textContent = "";
                iHaveBuzzed = false;
                myBuzzTime = null;
                updateBuzzerUI();

            } catch (e) {
                console.error("Lỗi JoinRoom:", e);
                setErrorMessage("Lỗi không xác định khi tham gia phòng.");
            }
        }

        function setupRealtimeListener(roomId) {
            if (supabaseChannel) { supabaseClient.removeChannel(supabaseChannel); } // SỬA

            supabaseChannel = supabaseClient.channel(`room_${roomId}`) // SỬA
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `id=eq.${roomId}` }, (payload) => {
                    if (payload.new && payload.new.room_data) {
                        handleRoomStateUpdate(payload.new.room_data);
                    }
                })
                .subscribe();
        }

        function handleRoomStateUpdate(data) {
            const oldBellSessionId = currentRoomData ? currentRoomData.bellSessionId : null;
            currentRoomData = data;

            if (oldBellSessionId && oldBellSessionId !== currentRoomData.bellSessionId) {
                iHaveBuzzed = false;
                myBuzzTime = null;
                previousBuzzCount = 0;
            }

            // Phát nhạc khi có người bấm
            const currentBuzzes = data.buzzes || [];
            if (currentBuzzes.length > previousBuzzCount) {
                playBuzzerSound();
            }
            previousBuzzCount = currentBuzzes.length;

            const myBuzzInThisSession = currentRoomData.buzzes.find(b => String(b.userId) === String(userId) && b.bellSessionId === currentRoomData.bellSessionId);
            if (myBuzzInThisSession) {
                iHaveBuzzed = true;
                myBuzzTime = myBuzzInThisSession.time;
            } else {
                iHaveBuzzed = false;
                myBuzzTime = null;
            }

            updateBuzzerUI();
        }

        function setBuzzerState(state, message) {
            buzzerBtn.disabled = true;
            buzzerBtn.className = "";
            buzzerStatus.className = "";
            if (state === 'active') {
                buzzerBtn.disabled = false;
                buzzerBtn.textContent = "Bấm chuông!";
                buzzerBtn.classList.add('active');
                buzzerStatus.textContent = "Sẵn sàng bấm!";
                buzzerStatus.classList.add('status-active');
            } else if (state === 'buzzed') {
                buzzerBtn.textContent = "Đã bấm";
                buzzerBtn.classList.add('buzzed');
                buzzerStatus.textContent = message;
                buzzerStatus.classList.add('status-buzzed');
            } else if (state === 'locked') {
                buzzerBtn.textContent = message;
                buzzerBtn.classList.add('locked');
                buzzerStatus.textContent = message;
                buzzerStatus.classList.add('status-waiting');
            }
        }

        function updateBuzzerUI() {
            if (!currentRoomData) { setBuzzerState("locked", "Đang tải..."); return; }
            const lockedUsersList = currentRoomData.lockedUsers || [];
            const normalizedLockedList = lockedUsersList.map(item => String(item).trim());
            const normalizedUserId = String(userId).trim();
            const normalizedUsername = String(username).trim();
            
            const isLockedByHost = normalizedLockedList.includes(normalizedUserId) || normalizedLockedList.includes(normalizedUsername);

            if (isLockedByHost) { setBuzzerState("locked", "Bạn bị khóa chuông"); return; }
            if (currentRoomData.bellStatus === 'locked' || currentRoomData.bellStatus === 'locked_winner') { setBuzzerState("locked", "Chuông đang khóa"); return; }
            
            if (iHaveBuzzed && currentRoomData.options.buzzCount === 'single') {
                const timeMessage = myBuzzTime !== null && myBuzzTime >= 0 ? `Đã bấm chuông: ${myBuzzTime.toFixed(3)}s` : "Bạn đã bấm chuông!";
                setBuzzerState("buzzed", timeMessage);
                return;
            }
            
            if (currentRoomData.bellStatus.startsWith('open')) { setBuzzerState("active", "Bấm chuông!"); return; }
            setBuzzerState("locked", "Đang chờ Host...");
        }

        async function handleBuzzerClick() {
            if (!currentRoomData || !userId || buzzerBtn.disabled || !currentRoomData.bellSessionId) return;

            playBuzzerSound();
            setBuzzerState("buzzed", "Đã bấm!");

            const bellOpenTimestamp = currentRoomData.bellOpenTimestamp;
            const buzzTime = bellOpenTimestamp ? ((Date.now() - new Date(bellOpenTimestamp).getTime()) / 1000) : 0;

            const newBuzz = {
                roomId: currentRoomId,
                username: username,
                userId: userId,
                bellSessionId: currentRoomData.bellSessionId,
                time: buzzTime
            };
            
            // Cập nhật trạng thái phòng trên Supabase
            const currentBuzzes = currentRoomData.buzzes || [];
            currentBuzzes.push(newBuzz);
            
            let updatedData = { ...currentRoomData, buzzes: currentBuzzes };

            // Logic khóa chuông ngay lập tức cho chế độ 'single-winner'
            if (currentRoomData.options.buzzMode === 'single-winner') {
                updatedData.bellStatus = 'locked_winner';
            }

            const { error } = await supabaseClient // SỬA
                .from('rooms')
                .update({ room_data: updatedData })
                .eq('id', currentRoomId);

            if (error) {
                console.error("Lỗi khi bấm chuông:", error);
                setBuzzerState("active", "Lỗi, thử lại!"); // Khôi phục trạng thái để thử lại
            }
            // Realtime listener sẽ cập nhật UI sau khi DB được cập nhật
        }

        document.getElementById('joinRoomBtn').addEventListener('click', joinRoom);
        buzzerBtn.addEventListener('click', handleBuzzerClick);
        setBuzzerState("locked", "Vui lòng nhập thông tin.");
    </script>
</body>

</html>