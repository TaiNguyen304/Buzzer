<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thí sinh - Bấm chuông</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* GIỮ NGUYÊN CSS CŨ */
        body {
            background-color: #F3F4F6;
            color: #111827;
            font-family: Arial, Helvetica, sans-serif;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            max-width: 32rem;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
        }

        #loginSection {
            background-color: #FFFFFF;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        #loginSection h1 {
            font-size: 1.875rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            text-align: center;
            color: blue;
        }

        .space-y-4>div {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: bold;
            color: purple;
            margin-bottom: 0.25rem;
            text-align: center;
            align-items: center;
        }

        input[type="number"],
        input[type="text"] {
            width: 94%;
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-size: 1.125rem;
            text-align: center;
            align-items: center;
            font-weight: bold;
        }

        input[type="number"] {
            font-family: Arial, Helvetica, sans-serif, monospace;
        }

        #roomCodeInput {
            background-color: white;
            color: black !important;
            font-weight: bold;
            border-color: purple;
            box-shadow: 0 0 0 3px purple;
        }

        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: purple;
            box-shadow: 0 0 0 3px purple;
        }

        #joinRoomBtn {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition-property: all;
            transition-duration: 200ms;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            background-color: yellow;
            color: #000000;
            width: 100%;
            font-size: 1.125rem;
            border: none;
            cursor: pointer;
        }

        #joinRoomBtn:hover {
            background-color: orange;
            color: #FFFFFF;
        }

        #errorMessage {
            color: red;
            text-align: center;
            font-weight: bold;
            margin-top: 1rem;
        }

        #buzzerSection {
            text-align: center;
        }

        #buzzerSection h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        #roomCodeDisplay {
            font-family: Arial, Helvetica, sans-serif, monospace;
            color: blue;
        }

        #buzzerSection h3 {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
        }

        #usernameDisplay {
            color: purple;
        }

        .buzzer-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.25rem;
        }

        #buzzerBtn {
            width: 600px;
            height: 200px;
            font-size: 2.5rem;
            font-weight: bold;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition-property: all;
            transition-duration: 200ms;
            transform-origin: center;
            border: none;
        }

        #buzzerBtn.active {
            background-color: green;
            color: #FFFFFF;
            cursor: pointer;
        }

        #buzzerBtn.active:hover {
            background-color: orange;
            transform: scale(1.05);
        }

        #buzzerBtn.buzzed {
            background-color: blue;
            color: #FFFFFF;
            cursor: not-allowed;
        }

        #buzzerBtn.locked {
            background-color: red;
            color: #FFFFFF;
            cursor: not-allowed;
        }

        #buzzerStatus {
            width: 600px;
            height: 5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }

        #buzzerStatus.status-waiting {
            background-color: #ff00cc;
            color: #FFFFFF;
        }

        #buzzerStatus.status-active {
            background-color: green;
            color: white;
        }

        #buzzerStatus.status-buzzed {
            background-color: red;
            color: #FFFFFF;
        }

        .latest-buzz {
            background-color: blue !important;
            color: white !important;
        }

        .latest-buzz td {
            background-color: blue !important;
            color: white !important;
            font-weight: bold;
        }

        #leaveRoomBtn {
            margin-top: 2rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            background-color: yellow;
            color: black;
            width: 100%;
            height: 100px;
            font-size: 1.125rem;
            border: none;
            cursor: pointer;
            transition: background-color 200ms;
        }

        #leaveRoomBtn:hover {
            background-color: orange;
            color: #FFFFFF;
            font-weight: bold;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-900 font-sans p-6 flex items-center justify-center min-h-screen">
    <audio id="buzzSound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>
    <div class="container">
        <div id="loginSection">
            <h1>Tham gia phòng</h1>
            <div class="space-y-4">
                <div>
                    <label for="roomCodeInput">Mã phòng (6 chữ số):</label>
                    <input type="number" id="roomCodeInput" maxlength="6">
                </div>
                <div>
                    <label for="usernameInput">Username (Tên của bạn):</label>
                    <input type="text" id="usernameInput">
                </div>
                <button id="joinRoomBtn">Xác nhận</button>
            </div>
            <p id="errorMessage"></p>
        </div>

        <div id="buzzerSection" style="display: none;">
            <h2>Phòng <span id="roomCodeDisplay"></span></h2>
            <h3>Chào, <span id="usernameDisplay"></span></h3>
            <div class="buzzer-controls">
                <button id="buzzerBtn" disabled>Đang kết nối...</button>
                <div id="buzzerStatus" class="status-waiting">Vui lòng chờ Host...</div>
            </div>
            <button id="leaveRoomBtn">Rời phòng</button>
        </div>
    </div>

    <script>
        // --- CẤU HÌNH SUPABASE ---
        const SUPABASE_URL = 'https://gyyjabuewruokczpqekz.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_K7-yvCKpi5qiV_N0WC3rMg_eG8MEHSV';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let userId = null;
        let currentRoomId = null;
        let username = null;
        let currentRoomData = null;
        let iHaveBuzzed = false;
        let myBuzzTime = null;
        let previousBuzzCount = 0;
        let supabaseChannel = null;

        // BIẾN QUAN TRỌNG: Lưu thời điểm MÁY CONTESTANT nhận được tín hiệu mở/reset
        let localBellStartTime = null;

        const loginSection = document.getElementById('loginSection');
        const buzzerSection = document.getElementById('buzzerSection');
        const buzzerBtn = document.getElementById('buzzerBtn');
        const buzzerStatus = document.getElementById('buzzerStatus');
        const errorMessage = document.getElementById('errorMessage');
        const buzzSound = document.getElementById('buzzSound');

        function playBuzzerSound() {
            if (buzzSound) { buzzSound.currentTime = 0; buzzSound.play().catch(e => console.log("Audio play failed", e)); }
        }

        document.getElementById('joinRoomBtn').textContent = 'Xác nhận';
        document.getElementById('joinRoomBtn').disabled = false;
        userId = `user-${Math.random().toString(36).substring(2, 9)}`;

        function setErrorMessage(message) {
            errorMessage.textContent = message;
            document.getElementById('joinRoomBtn').disabled = false;
        }

        async function joinRoom() {
            if (!userId) { setErrorMessage("Lỗi kết nối."); return; }
            const roomId = document.getElementById('roomCodeInput').value.trim();
            const inputUsername = document.getElementById('usernameInput').value.trim();
            if (!roomId || roomId.length !== 6) { setErrorMessage("Mã phòng phải là 6 chữ số."); return; }
            if (!inputUsername) { setErrorMessage("Vui lòng nhập Username."); return; }

            errorMessage.textContent = "Đang tham gia phòng...";
            document.getElementById('joinRoomBtn').disabled = true;

            try {
                let { data: room, error } = await supabaseClient.from('rooms').select('room_data').eq('id', roomId).single();
                if (error || !room) { setErrorMessage("Phòng không tồn tại hoặc lỗi server."); return; }

                currentRoomData = room.room_data;
                let participants = currentRoomData.participants || [];
                const newParticipant = { userId, username: inputUsername, isHost: false, isManager: false };
                // Lọc bỏ user cũ cùng tên nếu có (tránh trùng lặp)
                participants = participants.filter(p => !(!p.isHost && !p.isManager && String(p.username).toLowerCase() === String(inputUsername).toLowerCase()));
                participants.push(newParticipant);

                const { error: updateError } = await supabaseClient.from('rooms').update({
                    room_data: { ...currentRoomData, participants: participants },
                    updated_at: new Date().toISOString(), participants_changed_at: new Date().toISOString()
                }).eq('id', roomId);

                if (updateError) { setErrorMessage("Lỗi khi cập nhật danh sách."); return; }

                setupRealtimeListener(roomId);
                currentRoomId = roomId;
                username = inputUsername;
                loginSection.style.display = 'none';
                buzzerSection.style.display = 'block';
                document.getElementById('roomCodeDisplay').textContent = currentRoomId;
                document.getElementById('usernameDisplay').textContent = username;
                errorMessage.textContent = "";
                iHaveBuzzed = false;
                myBuzzTime = null;
                localBellStartTime = null;
                updateBuzzerUI();

            } catch (e) { console.error("Lỗi JoinRoom:", e); setErrorMessage("Lỗi không xác định."); }
        }

        function setupRealtimeListener(roomId) {
            if (supabaseChannel) { supabaseClient.removeChannel(supabaseChannel); }
            supabaseChannel = supabaseClient.channel(`room_${roomId}`)
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `id=eq.${roomId}` }, (payload) => {
                    if (payload.new && payload.new.room_data) { handleRoomStateUpdate(payload.new.room_data); }
                })
                .subscribe();
        }

        function handleRoomStateUpdate(data) {
            currentRoomData = data;

            const isBellOpen = currentRoomData.bellStatus.startsWith('open');

            // Kiểm tra xem mình đã bấm trong danh sách buzzes hiện tại chưa
            const myBuzz = (currentRoomData.buzzes || []).find(b => String(b.userId) === String(userId));

            if (myBuzz) {
                iHaveBuzzed = true;
                myBuzzTime = myBuzz.time;
            } else {
                iHaveBuzzed = false;
                myBuzzTime = null;
            }

            // Logic tính thời gian local
            if (isBellOpen && !iHaveBuzzed) {
                if (localBellStartTime === null) {
                    localBellStartTime = Date.now();
                }
            } else {
                localBellStartTime = null;
            }

            // Âm thanh khi có người mới bấm
            if ((data.buzzes || []).length > previousBuzzCount) {
                playBuzzerSound();
            }
            previousBuzzCount = (data.buzzes || []).length;

            updateBuzzerUI();
        }

        function setBuzzerState(state, message) {
            buzzerBtn.disabled = true; buzzerBtn.className = ""; buzzerStatus.className = "";
            if (state === 'active') {
                buzzerBtn.disabled = false; buzzerBtn.textContent = "Bấm chuông"; buzzerBtn.classList.add('active');
                buzzerStatus.textContent = "Sẵn sàng bấm!"; buzzerStatus.classList.add('status-active');
            } else if (state === 'buzzed') {
                buzzerBtn.textContent = "Đã bấm"; buzzerBtn.classList.add('buzzed');
                buzzerStatus.textContent = message; buzzerStatus.classList.add('status-buzzed');
            } else if (state === 'locked') {
                buzzerBtn.textContent = message; buzzerBtn.classList.add('locked');
                buzzerStatus.textContent = message; buzzerStatus.classList.add('status-waiting');
            }
        }

        function updateBuzzerUI() {
            if (!currentRoomData) { setBuzzerState("locked", "Đang tải..."); return; }
            const lockedUsersList = (currentRoomData.lockedUsers || []).map(item => String(item).trim());
            const isLockedByHost = lockedUsersList.includes(String(userId).trim()) || lockedUsersList.includes(String(username).trim());

            if (isLockedByHost) { setBuzzerState("locked", "Bạn bị khóa chuông"); return; }
            if (currentRoomData.bellStatus === 'locked' || currentRoomData.bellStatus === 'locked_winner') { setBuzzerState("locked", "Chuông đang khóa"); return; }

            if (iHaveBuzzed && currentRoomData.options.buzzCount === 'single') {
                const timeMessage = myBuzzTime !== null && myBuzzTime >= 0 ? `Đã bấm chuông: ${myBuzzTime.toFixed(3)}s` : "Bạn đã bấm chuông!";
                setBuzzerState("buzzed", timeMessage);
                return;
            }

            if (currentRoomData.bellStatus.startsWith('open')) { setBuzzerState("active", "Bấm chuông!"); return; }
            setBuzzerState("locked", "Đang chờ Host...");
        }

        async function handleBuzzerClick() {
            if (!currentRoomData || !userId || buzzerBtn.disabled) return;

            setBuzzerState("buzzed", "Đang ghi nhận...");

            let buzzTime = 0;
            if (localBellStartTime) {
                const offset = currentRoomData.startTimeOffset || 0;
                buzzTime = ((Date.now() - localBellStartTime) / 1000) + offset;
            }

            const newBuzz = {
                username: username,
                userId: userId,
                time: parseFloat(buzzTime.toFixed(3))
            };

            // Đảm bảo lấy đúng giá trị buzzMode từ options
            const isSingleWinner = (currentRoomData.options && currentRoomData.options.buzzMode === 'single-winner');

            // Gửi currentRoomId dưới dạng String
            const { error } = await supabaseClient.rpc('push_buzz_atomic', {
                room_id_input: String(currentRoomId),
                new_buzz_json: newBuzz,
                should_lock: !!isSingleWinner
            });

            if (error) {
                console.error("Lỗi bấm chuông:", error);
                alert("Lỗi: " + error.message);
                setBuzzerState("active", "Thử lại");
            }
        }

        async function leaveRoom() {
            if (!currentRoomId || !userId) { location.reload(); return; }
            let { data: room } = await supabaseClient.from('rooms').select('room_data').eq('id', currentRoomId).single();
            if (room) {
                const newParticipants = (room.room_data.participants || []).filter(p => String(p.userId) !== String(userId));
                await supabaseClient.from('rooms').update({ room_data: { ...room.room_data, participants: newParticipants }, updated_at: new Date().toISOString(), participants_changed_at: new Date().toISOString() }).eq('id', currentRoomId);
            }
            if (supabaseChannel) supabaseClient.removeChannel(supabaseChannel);
            location.reload();
        }

        document.getElementById('joinRoomBtn').addEventListener('click', joinRoom);
        buzzerBtn.addEventListener('click', handleBuzzerClick);
        document.getElementById('leaveRoomBtn').addEventListener('click', leaveRoom);

        // --- SỰ KIỆN PHÍM CTRL ĐỂ BẤM CHUÔNG ---
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Control' || event.ctrlKey) {
                if (buzzerSection.style.display !== 'none' && !buzzerBtn.disabled) {
                    handleBuzzerClick();
                }
            }
        });

        document.addEventListener("contextmenu", function (e) {
            e.preventDefault();
        });
    </script>
</body>

</html>