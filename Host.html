<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Host - Bảng điều khiển</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* GIỮ NGUYÊN CSS CŨ */
    .modal-body::-webkit-scrollbar {
      width: 8px;
    }

    .modal-body::-webkit-scrollbar-thumb {
      background-color: #9CA3AF;
      border-radius: 9999px;
    }

    .modal-body::-webkit-scrollbar-track {
      background-color: #F3F4F6;
    }

    .modal-actions-center {
      margin-top: 1.5rem;
      display: flex;
      justify-content: center;
      gap: 1rem;
    }

    body {
      background-color: #F3F4F6;
      font-family: Arial, Helvetica, sans-serif;
      padding: 1.5rem;
    }

    .container {
      max-width: 48rem;
      margin-left: auto;
      margin-right: auto;
      background-color: #FFFFFF;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    h1 {
      font-size: 1.875rem;
      font-weight: bold;
      margin-bottom: 1.5rem;
      text-align: center;
      color: blue;
    }

    .flex-wrap {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    button {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: bold;
      transition-duration: 200ms;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
      flex: 1 1 0%;
      cursor: pointer;
      border: none;
      height: 50px !important;
      margin-top: 10px;
    }

    button:hover {
      background-color: orange !important;
      color: #FFFFFF !important;
    }

    button:disabled {
      cursor: not-allowed;
      opacity: 1;
    }

    #createRoomBtn,
    #showParticipantsBtn,
    #joinRoomBtn {
      background-color: purple;
      color: #FFFFFF;
    }

    #roomCodeDisplay {
      display: none;
      padding: 0.75rem;
      background-color: purple;
      color: white;
      border-radius: 0.5rem;
      font-size: 1.5rem;
      font-family: Arial, Helvetica, sans-serif, monospace;
      text-align: center;
      flex: 1 1 0%;
      font-weight: bold;
    }

    #bellStatusDisplay {
      width: 80%;
      margin: auto;
      text-align: center;
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-weight: bold;
      color: #FFFFFF;
      font-size: 1.25rem;
      margin-bottom: 1rem;
      background-color: red;
    }

    label {
      display: block;
      font-size: 0.875rem;
      font-weight: bold;
      color: red;
      margin-bottom: 0.25rem;
      text-align: center;
    }

    input[type="number"] {
      width: 80%;
      display: block;
      margin-left: auto;
      margin-right: auto;
      padding: 0.5rem;
      border: 1px solid red;
      border-radius: 0.5rem;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      font-weight: bold;
    }

    input[type="text"].modal-input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #D1D5DB;
      border-radius: 0.5rem;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      font-weight: bold;
      box-sizing: border-box;
    }

    input[type="text"].modal-input:focus {
      outline: 2px solid transparent;
      outline-offset: 2px;
      border-color: purple;
      box-shadow: 0 0 0 3px purple;
    }

    input[type="number"]:focus {
      outline: 2px solid transparent;
      outline-offset: 2px;
      border-color: red;
      box-shadow: 0 0 0 3px red;
      font-weight: bold;
    }

    .grid-container {
      display: grid;
      grid-template-columns: repeat(1, minmax(0, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    @media (min-width: 768px) {
      .grid-container {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    #openBellInfiniteBtn,
    #resetBellBtn {
      background-color: blue;
      color: #FFFFFF;
    }

    #openBellTimedBtn,
    #showLockUsersBtn {
      background-color: green;
      color: #FFFFFF;
    }

    #lockBellBtn,
    #showBellOptionsBtn {
      background-color: #ff00cc;
      color: #FFFFFF;
    }

    .overflow-x-auto {
      width: 100%;
      overflow-x: auto;
    }

    .min-w-full {
      min-width: 100%;
    }

    table {
      border-collapse: collapse;
      border: 1px solid #D1D5DB;
    }

    thead th {
      padding: 1rem;
      background-color: rgb(255, 255, 0);
      color: #000000;
      font-weight: bold;
      font-size: 1.125rem;
      border: 1px solid #D1D5DB;
    }

    tbody {
      text-align: center;
      font-size: 1.125rem;
      font-weight: bold;
    }

    tbody td {
      padding: 0.75rem;
      border: 1px solid #D1D5DB;
      background-color: #FFFFFF;
      color: #000000;
    }

    .text-red-600 {
      color: red;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      transition-property: opacity;
      transition-duration: 300ms;
    }

    .modal-content {
      background-color: #FFFFFF;
      padding: 1.5rem;
      border-radius: 0.75rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
      max-width: 32rem;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-content h2 {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 1rem;
    }

    .modal-body {
      max-height: 16rem;
      overflow-y: auto;
      padding-right: 0.5rem;
    }

    .modal-close-btn {
      background-color: rgb(255, 0, 0);
      color: #FFFFFF;
    }

    #lockUsersModal .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    #saveLockedUsersBtn {
      background-color: green;
      color: #FFFFFF;
    }

    #confirmJoinBtn {
      background-color: green;
      color: white;
      font-weight: bold;
    }

    #resetAllLocksBtn {
      background-color: rgb(255, 255, 0);
      color: #000000;
    }

    #lockUsersList>div {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
      font-weight: bold;
    }

    #lockUsersList input[type="checkbox"] {
      height: 1.25rem;
      width: 1.25rem;
      color: green;
    }

    #lockUsersList label {
      text-align: left;
      display: inline;
      color: #111827;
      font-weight: bold;
      font-size: 1rem;
      margin: 0;
      padding: 0;
      cursor: pointer;
    }

    #saveBellOptionsBtn {
      background-color: green;
      color: #FFFFFF;
      font-weight: bold;
    }

    #bellOptionsModal .flex.items-center label {
      display: inline;
      margin-bottom: 0;
      text-align: left;
    }

    #joinRoomModal label {
      text-align: left;
      color: #111827;
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }

    #joinRoomModal .modal-body {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-height: none;
    }

    .fastest-buzz {
      background-color: purple !important;
      color: white !important;
    }

    .fastest-buzz td {
      background-color: purple !important;
      color: white !important;
      font-weight: bold;
    }

    .latest-buzz {
      background-color: blue !important;
      color: white !important;
      font-weight: bold;
    }

    .latest-buzz td {
      background-color: blue !important;
      color: white !important;
      font-weight: bold;
    }
  </style>
</head>

<body class="bg-gray-100 font-sans p-6">
  <audio id="buzzSound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>
  <div class="container">
    <h1>Bảng điều khiển Host</h1>
    <div class="flex-wrap">
      <button id="createRoomBtn">Tạo phòng</button>
      <button id="joinRoomBtn">Tham gia phòng (Quản lý)</button>
      <div id="roomCodeDisplay">Mã phòng: </div>
      <button id="showParticipantsBtn" disabled>Danh sách tham gia</button>
    </div>
    <div id="bellControlSection" style="display: none;">
      <div id="bellStatusDisplay">CHUÔNG ĐANG KHÓA</div>
      <label for="bellTimeInput">Thời gian mở chuông (giây):</label>
      <input type="number" id="bellTimeInput" value="10">
      <label for="interruptTimeInput" style="margin-top: 10px;">Thời gian ngắt chuông (giây):</label>
      <input type="number" id="interruptTimeInput" value="5">
      <div class="grid-container">
        <button id="openBellInfiniteBtn" disabled>Mở chuông vĩnh viễn</button>
        <button id="openBellTimedBtn" disabled>Mở chuông (Giới hạn)</button>
        <button id="lockBellBtn" disabled>Khóa chuông</button>
      </div>
      <div class="grid-container">
        <button id="resetBellBtn">Reset chuông</button>
        <button id="showLockUsersBtn">Chọn người bị khóa chuông</button>
        <button id="showBellOptionsBtn">Tùy chọn chuông</button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead>
            <tr>
              <th style="width: 50%;">Tên người chơi</th>
              <th style="width: 50%;">Thời gian bấm chuông</th>
            </tr>
          </thead>
          <tbody id="buzzTableBody">
            <tr>
              <td colspan="2">Chưa có ai bấm chuông</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="participantsModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h2 style="color: green;">Danh sách người tham gia</h2>
      <div id="participantsList" class="modal-body"></div>
      <div class="modal-actions-center"><button onclick="closeModal('participantsModal')"
          class="modal-close-btn text-white">Đóng</button></div>
    </div>
  </div>

  <div id="lockUsersModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h2>Chọn người bị khóa chuông</h2>
      <div id="lockUsersList" class="modal-body space-y-2"></div>
      <div class="mt-6 modal-actions">
        <button id="saveLockedUsersBtn">Lưu</button>
        <button id="resetAllLocksBtn">Reset tất cả</button>
        <button onclick="closeModal('lockUsersModal')" class="modal-close-btn">Đóng</button>
      </div>
    </div>
  </div>

  <div id="bellOptionsModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="text-align: left; max-width: 450px;">

      <div class="modal-body" style="display: flex; flex-direction: column; gap: 20px;">

        <div>
          <h3 style="font-weight: bold; font-size: 1.1rem; margin-bottom: 8px; color: purple;">Số lần bấm chuông/vòng:
          </h3>
          <div style="display: flex; flex-direction: column; gap: 8px; padding-left: 5px;">
            <label style="color: black; cursor: pointer; display: flex; align-items: center;">
              <input type="radio" id="opt-single-buzz" name="buzzCount" value="single" checked
                onchange="toggleExtraOptions()" style="margin-right: 10px;">
              Mỗi người chỉ được bấm 1 lần/vòng
            </label>
            <label style="color: black; cursor: pointer; display: flex; align-items: center;">
              <input type="radio" id="opt-multiple-buzz" name="buzzCount" value="multiple"
                onchange="toggleExtraOptions()" style="margin-right: 10px;">
              Mỗi người được bấm nhiều lần
            </label>
          </div>
        </div>

        <div>
          <h3 style="font-weight: bold; font-size: 1.1rem; margin-bottom: 8px; color: red;">Chế độ người thắng:</h3>
          <div style="display: flex; flex-direction: column; gap: 8px; padding-left: 5px;">
            <label style="color: black; cursor: pointer; display: flex; align-items: center;">
              <input type="radio" id="opt-single-winner" name="buzzMode" value="single-winner" checked
                onchange="toggleExtraOptions()" style="margin-right: 10px;">
              Một người bấm: Khóa chuông ngay lập tức
            </label>
            <label style="color: black; cursor: pointer; display: flex; align-items: center;">
              <input type="radio" id="opt-all-buzz" name="buzzMode" value="all-buzz" onchange="toggleExtraOptions()"
                style="margin-right: 10px;">
              Tất cả đều bấm: Chỉ khóa khi Host bấm Khóa
            </label>
          </div>
        </div>

        <div id="extraOptions" style="display: none; border-top: 1px solid #ddd; padding-top: 15px;">

          <div style="margin-bottom: 15px;">
            <h3 style="font-weight: bold; font-size: 1rem; margin-bottom: 5px; color: green;">Tính thời gian (Mở chuông
              giới hạn):</h3>
            <div style="display: flex; flex-direction: column; gap: 5px; padding-left: 15px;">
              <label style="color: black; cursor: pointer; font-size: 0.95rem; display: flex; align-items: center;">
                <input type="radio" id="timed-restart" name="timedOption" value="restart" checked
                  style="margin-right: 10px;">
                Tính lại thời gian từ đầu
              </label>
              <label style="color: black; cursor: pointer; font-size: 0.95rem; display: flex; align-items: center;">
                <input type="radio" id="timed-continue" name="timedOption" value="continue" style="margin-right: 10px;">
                Tính tiếp số thời gian còn lại
              </label>
            </div>
          </div>

          <div>
            <h3 style="font-weight: bold; font-size: 1rem; margin-bottom: 5px; color: blue;">Tính thời gian (Mở chuông
              vĩnh viễn):</h3>
            <div style="display: flex; flex-direction: column; gap: 5px; padding-left: 15px;">
              <label style="color: black; cursor: pointer; font-size: 0.95rem; display: flex; align-items: center;">
                <input type="radio" id="inf-restart" name="infOption" value="restart" checked
                  style="margin-right: 10px;">
                Tính lại thời gian từ 0.000s
              </label>
              <label style="color: black; cursor: pointer; font-size: 0.95rem; display: flex; align-items: center;">
                <input type="radio" id="inf-continue" name="infOption" value="continue" style="margin-right: 10px;">
                Tính tiếp số thời gian (từ người trước)
              </label>
            </div>
          </div>

          <div id="pauseMechanismOptions" style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px;">
            <h3
              style="font-weight: bold; font-size: 1rem; margin-bottom: 8px; color: #ff00cc; padding: 5px; text-align: left; border-radius: 4px;">
              Tạm dừng thời gian
            </h3>
            <div style="display: flex; flex-direction: column; gap: 8px; padding-left: 5px;">
              <label style="color: black; cursor: pointer; display: flex; align-items: center; font-size: 0.95rem;">
                <input type="checkbox" id="pause-standard" style="margin-right: 10px;">
                Tạm dừng thời gian
              </label>
              <label style="color: black; cursor: pointer; display: flex; align-items: center; font-size: 0.95rem;">
                <input type="checkbox" id="pause-interrupt" style="margin-right: 10px;">
                Ngắt chuông trong 1 khoảng thời gian
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-actions-center" style="display: flex; justify-content: center; gap: 15px; margin-top: 25px;">
        <button id="saveBellOptionsBtn"
          style="background-color: green; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">Lưu
          thay đổi</button>
        <button onclick="closeModal('bellOptionsModal')" class="modal-close-btn"
          style="background-color: red; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">Đóng</button>
      </div>
    </div>
  </div>

  <div id="joinRoomModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h2>Tham gia với tư cách Quản lý</h2>
      <div class="modal-body">
        <div><label for="joinRoomCodeInput">Nhập mã phòng:</label><input type="text" id="joinRoomCodeInput"
            class="modal-input"></div>
        <div><label for="joinUsernameInput">Nhập Username:</label><input type="text" id="joinUsernameInput"
            class="modal-input"></div>
      </div>
      <div class="modal-actions-center"><button id="confirmJoinBtn">Xác nhận</button><button id="closeJoinModalBtn"
          class="modal-close-btn">Đóng</button></div>
    </div>
  </div>

  <script>
    // --- CẤU HÌNH SUPABASE ---
    const SUPABASE_URL = 'https://gyyjabuewruokczpqekz.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_K7-yvCKpi5qiV_N0WC3rMg_eG8MEHSV';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let userId = null;
    let currentRoomId = null;
    let currentRoomData = null;
    let bellTimer = null;
    let currentParticipants = [];
    let isHost = false;
    let isManager = false;
    let managerUsername = null;
    let previousBuzzCount = -1; // KHỞI TẠO LÀ -1 ĐỂ NHẬN DIỆN LẦN ĐẦU
    let supabaseChannel = null;
    let interruptTimer = null;
    let lastBellType = 'infinite'; 
    const buzzSound = document.getElementById('buzzSound');

    // HÀM PHÁT ÂM THANH
    function playBuzzerSound() { 
        if (buzzSound) { 
            buzzSound.currentTime = 0; 
            buzzSound.play().catch(e => console.log("Audio playback was prevented. Please interact with the page first.")); 
        } 
    }

    userId = `host-${Math.random().toString(36).substring(2, 9)}`;
    document.getElementById('createRoomBtn').textContent = 'Tạo phòng'; document.getElementById('createRoomBtn').disabled = false;
    document.getElementById('joinRoomBtn').textContent = 'Tham gia phòng (Quản lý)'; document.getElementById('joinRoomBtn').disabled = false;

    function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
    function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }

    function enableButtons() {
      const isController = isHost || isManager; const hasRoom = !!currentRoomId;
      document.getElementById('showParticipantsBtn').disabled = !hasRoom;
      document.getElementById('openBellInfiniteBtn').disabled = !isController || !hasRoom;
      document.getElementById('openBellTimedBtn').disabled = !isController || !hasRoom;
      document.getElementById('lockBellBtn').disabled = !isController || !hasRoom;
      document.getElementById('resetBellBtn').disabled = !isController || !hasRoom;
      document.getElementById('showLockUsersBtn').disabled = !isController || !hasRoom;
      document.getElementById('showBellOptionsBtn').disabled = !isController || !hasRoom;
    }

    function setupRealtimeListener(roomId) {
      if (supabaseChannel) { supabaseClient.removeChannel(supabaseChannel); }
      supabaseChannel = supabaseClient
        .channel('public:rooms')
        .on('postgres_changes', {
          event: 'UPDATE',
          schema: 'public',
          table: 'rooms',
          filter: `id=eq.${roomId}`
        }, payload => {
          handleRoomStateUpdate(payload.new.room_data);
        })
        .subscribe();
    }

    function handleRoomStateUpdate(data) {
      if (!data) return;

      currentRoomData = data;
      currentParticipants = Array.isArray(data.participants) ? data.participants : [];

      if (data.bellStatus === 'open_timed') lastBellType = 'timed';
      if (data.bellStatus === 'open_infinite') lastBellType = 'infinite';

      const playerCount = currentParticipants.filter(p => !p.isHost && !p.isManager).length;
      document.getElementById('showParticipantsBtn').textContent = `Danh sách tham gia (${playerCount})`;

      if (data.bellStatus !== 'open_timed' && data.bellStatus !== 'open_infinite') {
        if (bellTimer) {
          clearTimeout(bellTimer);
          bellTimer = null;
        }
      }

      // TỰ ĐỘNG PHÁT ÂM THANH KHI CÓ NGƯỜI BẤM MỚI (CHẠY CHO CẢ HOST & MANAGER)
      const currentBuzzes = data.buzzes || [];
      if (previousBuzzCount !== -1 && currentBuzzes.length > previousBuzzCount) {
        playBuzzerSound();
      }
      previousBuzzCount = currentBuzzes.length;

      // CƠ CHẾ NGẮT CHUÔNG TỰ ĐỘNG
      if (data.bellStatus === 'locked_winner' && data.options && data.options.pauseInterrupt) {
        if (!interruptTimer) {
          const interruptDuration = parseFloat(document.getElementById('interruptTimeInput').value) || 5;
          interruptTimer = setTimeout(async () => {
            if (lastBellType === 'timed') {
              openBell(true);
            } else {
              openBell(false);
            }
            interruptTimer = null;
          }, interruptDuration * 1000);
        }
      } else {
        if (interruptTimer) {
          clearTimeout(interruptTimer);
          interruptTimer = null;
        }
      }

      renderBuzzTable(currentBuzzes);
      updateBellUI();
      updateBellOptionsUI(data.options);
      updateLockedUsersUI(Array.isArray(data.lockedUsers) ? data.lockedUsers : []);

      if (document.getElementById('participantsModal').style.display !== 'none') {
        renderParticipantsList();
      }
      if (document.getElementById('lockUsersModal').style.display !== 'none') {
        renderLockUsersList();
      }

      enableButtons();
    }

    async function updateRoomData(data) {
      if (!currentRoomId || (!isHost && !isManager)) return;
      let { data: room } = await supabaseClient.from('rooms').select('room_data').eq('id', currentRoomId).single();
      if (!room) return;
      let updatedData = { ...room.room_data };
      if (data.reset) {
        updatedData.buzzes = [];
        updatedData.bellSessionId = Date.now().toString();
        updatedData.bellOpenTimestamp = null;
        updatedData.bellStatus = 'locked';
        previousBuzzCount = 0; // Reset số lượng chuông về 0 để đồng bộ âm thanh
      }
      if (data.bellStatus) {
        updatedData.bellStatus = data.bellStatus;
        if (data.bellStatus.startsWith('open')) { updatedData.bellOpenTimestamp = new Date().toISOString(); }
        else { if (bellTimer) clearTimeout(bellTimer); bellTimer = null; }
      }
      if (data.lockedUsers) updatedData.lockedUsers = data.lockedUsers;
      if (data.options) updatedData.options = { ...updatedData.options, ...data.options };
      if (data.reset && data.bellStatus === 'open_infinite') {
        updatedData.bellStatus = 'open_infinite';
        updatedData.bellOpenTimestamp = new Date().toISOString();
      }
      if (data.startTimeOffset !== undefined) updatedData.startTimeOffset = data.startTimeOffset;

      await supabaseClient.from('rooms').update({ room_data: updatedData, updated_at: new Date().toISOString(), participants_changed_at: new Date().toISOString() }).eq('id', currentRoomId);
    }

    async function createRoom() {
      if (!userId) return;
      document.getElementById('createRoomBtn').disabled = true;
      const roomId = Math.floor(100000 + Math.random() * 900000).toString();

      const initialRoomData = {
        id: roomId,
        bellStatus: 'locked',
        bellSessionId: Date.now().toString(),
        bellOpenTimestamp: null,
        buzzes: [],
        lockedUsers: [],
        options: { buzzCount: 'single', buzzMode: 'single-winner', pauseStandard: true, pauseInterrupt: false },
        participants: [{ userId: userId, username: 'Host', isHost: true }]
      };

      const { error } = await supabaseClient.from('rooms').insert([{
        id: roomId,
        room_data: initialRoomData,
        updated_at: new Date().toISOString(),
        participants_changed_at: new Date().toISOString()
      }]);

      if (error) { document.getElementById('createRoomBtn').disabled = false; return; }

      currentRoomId = roomId;
      isHost = true;
      isManager = false;

      setupRealtimeListener(roomId);
      handleRoomStateUpdate(initialRoomData);

      document.getElementById('roomCodeDisplay').textContent = `Mã phòng: ${currentRoomId}`;
      document.getElementById('roomCodeDisplay').style.display = 'block';
      document.getElementById('createRoomBtn').textContent = `Mã phòng: ${currentRoomId}`;
      document.getElementById('createRoomBtn').disabled = true;
      document.getElementById('joinRoomBtn').style.display = 'none';
      document.getElementById('bellControlSection').style.display = 'block';
    }

    async function confirmJoinRoom() {
      const roomId = document.getElementById('joinRoomCodeInput').value.trim();
      const usernameInput = document.getElementById('joinUsernameInput').value.trim();
      if (!roomId || !usernameInput || !userId) return;

      let { data: room } = await supabaseClient.from('rooms').select('room_data').eq('id', roomId).single();
      if (!room) { alert("Không tìm thấy phòng!"); return; }

      const participants = room.room_data.participants || [];
      const newParticipant = { userId, username: usernameInput, isManager: true, isHost: false };

      const filteredParticipants = participants.filter(p =>
        !(!p.isHost && !p.isManager && String(p.username).toLowerCase() === String(usernameInput).toLowerCase())
        && String(p.userId) !== String(userId)
      );
      filteredParticipants.push(newParticipant);

      const updatedRoomData = { ...room.room_data, participants: filteredParticipants };
      await supabaseClient.from('rooms').update({
        room_data: updatedRoomData,
        updated_at: new Date().toISOString(),
        participants_changed_at: new Date().toISOString()
      }).eq('id', roomId);

      currentRoomId = roomId;
      isHost = false;
      isManager = true;
      managerUsername = usernameInput;

      setupRealtimeListener(roomId);
      handleRoomStateUpdate(updatedRoomData);

      document.getElementById('roomCodeDisplay').textContent = `Mã phòng: ${currentRoomId}`;
      document.getElementById('roomCodeDisplay').style.display = 'block';
      document.getElementById('createRoomBtn').textContent = `Đã tham gia: ${currentRoomId}`;
      document.getElementById('createRoomBtn').disabled = true;
      document.getElementById('joinRoomBtn').style.display = 'none';
      document.getElementById('bellControlSection').style.display = 'block';

      closeModal('joinRoomModal');
    }

    async function openBell(isTimed = false) {
      if (!currentRoomId || (!isHost && !isManager)) return;

      if (bellTimer) {
        clearTimeout(bellTimer);
        bellTimer = null;
      }

      let status = isTimed ? "open_timed" : "open_infinite";
      const opts = currentRoomData.options || {};
      let secondsToRun = parseFloat(document.getElementById('bellTimeInput').value) || 10;
      let startTimeOffset = 0;

      const lastBuzz = (currentRoomData.buzzes && currentRoomData.buzzes.length > 0)
        ? currentRoomData.buzzes[currentRoomData.buzzes.length - 1] : null;

      if (isTimed) {
        if (opts.timedOption === 'continue' && lastBuzz) {
          secondsToRun = Math.max(0, secondsToRun - lastBuzz.time);
          startTimeOffset = lastBuzz.time;
        }

        bellTimer = setTimeout(async () => {
          const { data } = await supabaseClient.from('rooms').select('room_data').eq('id', currentRoomId).single();
          if (data && data.room_data.bellStatus.startsWith('open')) {
            lockBell();
          }
        }, (secondsToRun * 1000) + 100);
      } else {
        if (opts.infOption === 'continue' && lastBuzz) {
          startTimeOffset = lastBuzz.time;
        }
      }

      await updateRoomData({
        bellStatus: status,
        bellOpenTimestamp: new Date().toISOString(),
        startTimeOffset: startTimeOffset
      });
    }

    async function lockBell() {
      if (!currentRoomId) return;
      if (bellTimer) {
        clearTimeout(bellTimer);
        bellTimer = null;
      }
      await updateRoomData({ bellStatus: 'locked' });
    }

    async function resetBell() {
      if (!currentRoomId) return;
      if (bellTimer) {
        clearTimeout(bellTimer);
        bellTimer = null;
      }
      document.getElementById('buzzTableBody').innerHTML = `<tr><td colspan="2" class="text-center py-4">Đang reset chuông...</td></tr>`;

      const payload = {
        reset: true,
        buzzes: [],
        startTimeOffset: 0,
        bellStatus: 'locked',
        bellOpenTimestamp: null
      };

      if (currentRoomData && currentRoomData.bellStatus === 'open_infinite') {
        payload.bellStatus = 'open_infinite';
        payload.bellOpenTimestamp = new Date().toISOString();
      }

      await updateRoomData(payload);
    }

    function updateBellUI() {
      if (!currentRoomData || !currentRoomData.bellStatus) {
        const display = document.getElementById('bellStatusDisplay');
        display.style.backgroundColor = 'red';
        display.textContent = 'CHUÔNG ĐANG KHÓA';
        return;
      }

      const status = currentRoomData.bellStatus;
      const display = document.getElementById('bellStatusDisplay');

      switch (status) {
        case 'open_infinite':
          display.style.backgroundColor = 'blue';
          display.textContent = 'CHUÔNG ĐANG MỞ (VÔ HẠN)';
          break;
        case 'open_timed':
          display.style.backgroundColor = 'green';
          display.textContent = 'CHUÔNG ĐANG MỞ (CÓ TÍNH GIỜ)';
          break;
        case 'locked_winner':
          display.style.backgroundColor = '#ff00cc';
          display.textContent = 'ĐÃ CÓ NGƯỜI BẤM!';
          break;
        case 'locked':
        default:
          display.style.backgroundColor = 'red';
          display.textContent = 'CHUÔNG ĐANG KHÓA';
          break;
      }
    }

    function updateBellOptionsUI(options) {
      if (!options) return;
      document.getElementById('opt-single-buzz').checked = options.buzzCount === 'single';
      document.getElementById('opt-multiple-buzz').checked = options.buzzCount === 'multiple';
      document.getElementById('opt-single-winner').checked = options.buzzMode === 'single-winner';
      document.getElementById('opt-all-buzz').checked = options.buzzMode === 'all-buzz';

      if (options.timedOption) {
        const el = document.getElementById('timed-' + options.timedOption);
        if (el) el.checked = true;
      }
      if (options.infOption) {
        const el = document.getElementById('inf-' + options.infOption);
        if (el) el.checked = true;
      }

      document.getElementById('pause-standard').checked = !!options.pauseStandard;
      document.getElementById('pause-interrupt').checked = !!options.pauseInterrupt;

      toggleExtraOptions();
    }

    function renderBuzzTable(buzzes) {
      const tableBody = document.getElementById('buzzTableBody');
      if (buzzes.length === 0) { tableBody.innerHTML = `<tr><td colspan="2">Chưa có ai bấm chuông</td></tr>`; return; }

      const opts = currentRoomData.options || {};
      const isMultipleBuzz = opts.buzzCount === 'multiple';
      const isSingleBuzzCount = opts.buzzCount === 'single';
      const isAllBuzzMode = opts.buzzMode === 'all-buzz';
      
      let latestBuzzPerUser = new Map();
      if (isMultipleBuzz) { 
        buzzes.forEach(buzz => { 
          const buzzTime = buzz.time !== undefined ? buzz.time : 0; 
          const currentLatest = latestBuzzPerUser.get(buzz.username); 
          if (currentLatest === undefined || buzzTime > (currentLatest.time || 0)) { 
            latestBuzzPerUser.set(buzz.username, buzz); 
          } 
        }); 
      }
      
      let fastestUserId = null;
      if (isAllBuzzMode && isSingleBuzzCount && buzzes.length > 0) { 
        const sortedBuzzes = [...buzzes].sort((a, b) => (a.time || 0) - (b.time || 0)); 
        fastestUserId = sortedBuzzes[0].userId; 
      }

      tableBody.innerHTML = buzzes.map(buzz => {
        const timeDiff = buzz.time !== undefined && buzz.time !== null ? buzz.time : 0;
        let rowClass = "";
        if (isAllBuzzMode && isSingleBuzzCount && String(buzz.userId) === String(fastestUserId)) { rowClass = "fastest-buzz"; }
        else if (isMultipleBuzz) { 
          const latestBuzz = latestBuzzPerUser.get(buzz.username); 
          if (latestBuzz && String(latestBuzz.userId) === String(buzz.userId) && (latestBuzz.time || 0) === timeDiff) { 
            rowClass = "latest-buzz"; 
          } 
        }
        return `<tr class="${rowClass}"><td style="width: 50%;">${buzz.username}</td><td style="width: 50%;">${timeDiff.toFixed(3)}s</td></tr>`;
      }).join('');
    }

    function renderParticipantsList() {
      const participants = Array.isArray(currentParticipants) ? currentParticipants : [];
      if (participants.length === 0) { document.getElementById('participantsList').innerHTML = "<strong>Chưa có ai tham gia.</strong>"; return; }
      const sorted = [...participants].sort((a, b) => { const roleScore = p => p.isHost ? 1 : p.isManager ? 2 : 3; return roleScore(a) - roleScore(b) || (a.username || '').localeCompare(b.username || ''); });
      document.getElementById('participantsList').innerHTML = sorted.map(p => {
        let color = p.isHost ? 'blue' : p.isManager ? 'red' : 'purple';
        return `<p style="font-weight: bold; font-size: 1.125rem; padding: 0.5rem; color: ${color};">${p.username}</p>`;
      }).join('');
    }

    function renderLockUsersList() {
      const contestants = currentParticipants.filter(p => !p.isHost && !p.isManager);
      document.getElementById('lockUsersList').innerHTML = contestants.length ? contestants.map(p => {
        const val = String(p.userId || p.username); const checked = (currentRoomData.lockedUsers || []).some(u => String(u) === val);
        return `<div style="display: flex; align-items: center;"><input type="checkbox" value="${val}" ${checked ? 'checked' : ''} style="height: 1.25rem; width: 1.25rem; margin-right: 0.75rem;"><label>${p.username}</label></div>`;
      }).join('') : "<strong>Chưa có người tham gia.</strong>";
    }
    
    function updateLockedUsersUI(locked) { if (!locked) return; document.querySelectorAll('#lockUsersList input').forEach(cb => cb.checked = locked.includes(cb.value)); }
    async function saveLockedUsers() { if (!currentRoomId) return; const locked = Array.from(document.querySelectorAll('#lockUsersList input:checked')).map(cb => cb.value); await updateRoomData({ lockedUsers: locked }); closeModal('lockUsersModal'); }
    async function resetAllLocks() { await updateRoomData({ lockedUsers: [] }); renderLockUsersList(); }
    
    async function saveBellOptions() {
      if (!currentRoomId) return;
      const buzzCount = document.querySelector('input[name="buzzCount"]:checked').value;
      const buzzMode = document.querySelector('input[name="buzzMode"]:checked').value;
      const timedOption = document.querySelector('input[name="timedOption"]:checked').value;
      const infOption = document.querySelector('input[name="infOption"]:checked').value;
      const pauseStandard = document.getElementById('pause-standard').checked;
      const pauseInterrupt = document.getElementById('pause-interrupt').checked;

      await updateRoomData({
        options: { buzzCount, buzzMode, timedOption, infOption, pauseStandard, pauseInterrupt }
      });
      closeModal('bellOptionsModal');
    }

    async function leaveRoomManager() { if (isManager && currentRoomId) { let { data: room } = await supabaseClient.from('rooms').select('room_data').eq('id', currentRoomId).single(); if (room) { const parts = (room.room_data.participants || []).filter(p => String(p.userId) !== String(userId)); await supabaseClient.from('rooms').update({ room_data: { ...room.room_data, participants: parts }, updated_at: new Date(), participants_changed_at: new Date() }).eq('id', currentRoomId); } } }

    document.getElementById('createRoomBtn').addEventListener('click', createRoom);
    document.getElementById('joinRoomBtn').addEventListener('click', () => { openModal('joinRoomModal'); });
    document.getElementById('closeJoinModalBtn').addEventListener('click', () => { closeModal('joinRoomModal'); });
    document.getElementById('confirmJoinBtn').addEventListener('click', confirmJoinRoom);
    document.getElementById('showParticipantsBtn').addEventListener('click', () => { renderParticipantsList(); openModal('participantsModal'); });
    document.getElementById('showLockUsersBtn').addEventListener('click', () => { renderLockUsersList(); openModal('lockUsersModal'); });
    document.getElementById('showBellOptionsBtn').addEventListener('click', () => { updateBellOptionsUI(currentRoomData.options); openModal('bellOptionsModal'); });
    document.getElementById('openBellInfiniteBtn').addEventListener('click', () => openBell(false));
    document.getElementById('openBellTimedBtn').addEventListener('click', () => openBell(true));
    document.getElementById('lockBellBtn').addEventListener('click', lockBell);
    document.getElementById('resetBellBtn').addEventListener('click', resetBell);
    document.getElementById('saveLockedUsersBtn').addEventListener('click', saveLockedUsers);
    document.getElementById('resetAllLocksBtn').addEventListener('click', resetAllLocks);
    document.getElementById('saveBellOptionsBtn').addEventListener('click', saveBellOptions);
    window.onbeforeunload = function () { leaveRoomManager(); };
    enableButtons();

    function toggleExtraOptions() {
      const isSingleWinner = document.getElementById('opt-single-winner').checked;
      const extraSection = document.getElementById('extraOptions');
      extraSection.style.display = isSingleWinner ? 'block' : 'none';
    }

    document.addEventListener("contextmenu", function (e) {
      e.preventDefault();
    });
  </script>
</body>

</html>